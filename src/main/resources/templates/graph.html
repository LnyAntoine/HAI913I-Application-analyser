<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Call Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
    <style>
        #calculatorResults ul { list-style: none; padding: 0; }
        #calculatorResults li { margin-bottom: 0.7em; }
        #graph { margin-top: 2em; text-align: center; }
        #zoomControls { text-align: center; margin: 1em 0; }
        #zoomControls button { cursor: pointer; }
    </style>
</head>
<body>
    <h1>Générateur de graphe d'appels</h1>
    <form id="dirForm">
        <label for="directory">Chemin du dossier :</label>
        <input type="text" id="directory" name="directory" required>
        <label for="x">Valeur de X :</label>
        <input type="number" id="x" name="x" value="0" min="0" required>
        <label for="analysisType">Type d'analyse :</label>
        <select id="analysisType" name="analysisType">
            <option value="all">Tout</option>
            <option value="statistics">Statistiques</option>
            <option value="coupling">Couplage</option>
            <option value="clustering">Clustering</option>
            <option value="calling">Appels</option>
        </select>
        <label for="cp">CP (pour clustering) :</label>
        <input type="number" id="cp" name="cp" value="0.5" step="0.01" min="0" max="1">
        <button type="submit">Analyser l'application</button>
    </form>
    <div id="calculatorResults"></div>
    <div id="zoomcontrol">
        <div id="idc"></div>
    </div>
    <div id="graphContainer" style="margin-top:2em; text-align:left; overflow-x:auto; overflow-y:auto; max-width:90vw; max-height:70vh; min-height:30px; padding:0;">
        <div id="graph"></div>
    </div>
    <div id="couplingGraphContainer" style="margin-top:2em; text-align:left; overflow-x:auto; overflow-y:auto; max-width:90vw; max-height:70vh; min-height:30px; padding:0;">
        <div id="couplingGraph"></div>
    </div>

    <div id="clusteringGraphContainer" style="margin-top:2em; text-align:left; overflow-x:auto; overflow-y:auto; max-width:90vw; max-height:70vh; min-height:30px; padding:0;">
        <div id="clusteringGraph"></div>
    </div>
    <script>
        document.getElementById('dirForm').onsubmit = async function(e) {
            e.preventDefault();
            const dir = document.getElementById('directory').value;
            const x = document.getElementById('x').value;
            const type = document.getElementById('analysisType').value;
            const cp = document.getElementById('cp').value;

            // Clear previous graphs
            document.getElementById('graph').innerHTML = '';
            document.getElementById('couplingGraph').innerHTML = '';
            document.getElementById('clusteringGraph').innerHTML = '';
            document.getElementById('calculatorResults').innerHTML = '';

            let url = '/getGraph';
            let body = 'directory=' + encodeURIComponent(dir) + '&x=' + encodeURIComponent(x);

            if (type === 'calling') {
                url = '/analyze/calling';
            } else if (type === 'coupling') {
                url = '/analyze/coupling';
                body = 'directory=' + encodeURIComponent(dir);
            } else if (type === 'clustering') {
                url = '/analyze/clustering';
                body = 'directory=' + encodeURIComponent(dir) + '&cp=' + encodeURIComponent(cp);
            } else if (type === 'statistics') {
                url = '/analyze/statistics';
                body = 'directory=' + encodeURIComponent(dir) + '&x=' + encodeURIComponent(x);
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: body
            });
            const data = await response.json();

            // Data peut contenir différentes clefs selon l'endpoint
            if (data.statisticData) {
                const stat = data.statisticData;
                // Si endpoint combiné, stat peut être l'objet result/order
                if (stat.result && stat.order) {
                    showCalculatorResults(stat.result, stat.order);
                } else if (stat.statisticData) {
                    // cas where combined returned nested map
                    showCalculatorResults(stat.statisticData.result, stat.statisticData.order);
                } else {
                    // cas endpoint /analyze/statistics
                    showCalculatorResults(stat.result || stat, stat.order || []);
                }
            }

            if (data.callGraphData) {
                drawCallingGraph(data.callGraphData);
            } else if (data.couplingGraphData) {
                drawCouplingGraphViz(data.couplingGraphData);
            } else if (data.clusterGraphData) {
                drawClusteringGraphViz(data.clusterGraphData);
            } else {
                // pour endpoint combiné on peut avoir plusieurs
                if (data.callGraphData) drawCallingGraph(data.callGraphData);
                if (data.couplingGraphData) drawCouplingGraphViz(data.couplingGraphData);
                if (data.clusterGraphData) drawClusteringGraphViz(data.clusterGraphData);
            }
        };
        function showCalculatorResults(results, order) {
            const div = document.getElementById('calculatorResults');
            if (!results) {
                div.innerHTML = '';
                return;
            }
            let html = '<h2>Résultats Calculator</h2><ul>';
            for (const key of order) {
                if (results[key]) {
                    html += `<li><b>${key}</b> : <pre style="display:inline">${results[key]}</pre></li>`;
                }
            }
            html += '</ul>';
            div.innerHTML = html;
        }

        function drawClusteringGraphViz(dot){
            try {
                const viz = new Viz();
                viz.renderSVGElement(dot)
                    .then(function(element) {
                        element.style.maxWidth = '100%';
                        element.style.height = 'auto';
                        element.style.width = '100%';
                        element.style.display = 'block';
                        element.style.margin = '0';
                        element.style.padding = '0';
                        element.id = 'graphSvg';
                        document.getElementById('clusteringGraph').appendChild(element);
                        addZoomControls();
                    })
                    .catch(function(error) {
                        document.getElementById('clusteringGraph').innerHTML = '<b>Erreur lors du rendu du graphe.</b>';
                    });
            } catch (e) {
                document.getElementById('clusteringGraph').innerHTML = '<b>Erreur lors du rendu du graphe.</b>';
            }
        }

        function drawCouplingGraphViz(dot){
            try {
                const viz = new Viz();
                viz.renderSVGElement(dot)
                    .then(function(element) {
                        element.style.maxWidth = '100%';
                        element.style.height = 'auto';
                        element.style.width = '100%';
                        element.style.display = 'block';
                        element.style.margin = '0';
                        element.style.padding = '0';
                        element.id = 'graphSvg';
                        document.getElementById('couplingGraph').appendChild(element);
                        addZoomControls();
                    })
                    .catch(function(error) {
                        document.getElementById('couplingGraph').innerHTML = '<b>Erreur lors du rendu du graphe.</b>';
                    });
            } catch (e) {
                document.getElementById('couplingGraph').innerHTML = '<b>Erreur lors du rendu du graphe.</b>';
            }
        }
        function drawCallingGraph(dot) {
            try {
                const viz = new Viz();
                viz.renderSVGElement(dot)
                    .then(function(element) {
                        element.style.maxWidth = '100%';
                        element.style.height = 'auto';
                        element.style.width = '100%';
                        element.style.display = 'block';
                        element.style.margin = '0';
                        element.style.padding = '0';
                        element.id = 'graphSvg';
                        document.getElementById('graph').appendChild(element);
                        addZoomControls();
                    })
                    .catch(function(error) {
                        document.getElementById('graph').innerHTML = '<b>Erreur lors du rendu du graphe.</b>';
                    });
            } catch (e) {
                document.getElementById('graph').innerHTML = '<b>Erreur lors du rendu du graphe.</b>';
            }
        }
        // Ajout des contrôles de zoom dynamiques
        function addZoomControls() {
            let controls = document.getElementById('zoomControls');
            if (!controls) {
                controls = document.createElement('div');
                controls.id = 'zoomControls';
                controls.style.textAlign = 'center';
                controls.style.margin = '1em 0';
                controls.innerHTML = `
                    <button type="button" id="zoomOut">-</button>
                    <input type="range" id="zoomSlider" min="0.1" max="8" step="0.01" value="0.6" style="width:180px;vertical-align:middle;">
                    <button type="button" id="zoomIn">+</button>
                `;
                document.getElementById('zoomcontrol').insertBefore(controls, document.getElementById('idc'));
            }
            const svg = document.getElementById('graphSvg');
            const slider = document.getElementById('zoomSlider');
            const zoomIn = document.getElementById('zoomIn');
            const zoomOut = document.getElementById('zoomOut');
            function setZoom(val) {
                if (!svg) return;
                svg.style.transform = `scale(${val})`;
                svg.style.transformOrigin = 'top left';
            }
            slider.oninput = function() { setZoom(this.value); };
            zoomIn.onclick = function() {
                let v = Math.min(4, parseFloat(slider.value) + 0.1);
                slider.value = v;
                setZoom(v);
            };
            zoomOut.onclick = function() {
                let v = Math.max(0.2, parseFloat(slider.value) - 0.1);
                slider.value = v;
                setZoom(v);
            };
            // Valeur initiale
            setZoom(slider.value);
        }
    </script>
</body>
</html>
