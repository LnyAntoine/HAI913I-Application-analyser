<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Call Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <h1>Générateur de graphe d'appels</h1>
    <form id="dirForm">
        <label for="directory">Chemin du dossier :</label>
        <input type="text" id="directory" name="directory" required>
        <button type="submit">Générer le graphe</button>
    </form>
    <div id="graph"></div>
    <script>
        document.getElementById('dirForm').onsubmit = async function(e) {
            e.preventDefault();
            const dir = document.getElementById('directory').value;
            const response = await fetch('/getGraph', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'directory=' + encodeURIComponent(dir)
            });
            const data = await response.json();
            drawGraph(data);
        };
        function drawGraph(data) {
            document.getElementById('graph').innerHTML = '';
            const width = 900, height = 700;
            const svg = d3.select('#graph').append('svg')
                .attr('width', width)
                .attr('height', height)
                .call(d3.zoom().on('zoom', function (event) {
                    svg.attr('transform', event.transform);
                }))
                .append('g');
            // Ajout du marqueur de flèche
            svg.append('defs').append('marker')
                .attr('id', 'arrow')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 22)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#888');
            const simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(180))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2));
            const link = svg.append('g')
                .attr('stroke', '#888')
                .attr('stroke-opacity', 0.5)
                .selectAll('line')
                .data(data.links)
                .enter().append('line')
                .attr('stroke-width', 1.5)
                .attr('marker-end', 'url(#arrow)');
            const node = svg.append('g')
                .selectAll('circle')
                .data(data.nodes)
                .enter().append('circle')
                .attr('r', 16)
                .attr('fill', '#fff')
                .attr('stroke', '#69b3a2')
                .attr('stroke-width', 3)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('stroke', '#ff6600').attr('stroke-width', 5);
                    link.attr('stroke', l => l.source.id === d.id || l.target.id === d.id ? '#ff6600' : '#888')
                        .attr('stroke-opacity', l => l.source.id === d.id || l.target.id === d.id ? 1 : 0.2);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).attr('stroke', '#69b3a2').attr('stroke-width', 3);
                    link.attr('stroke', '#888').attr('stroke-opacity', 0.5);
                });
            // Ajout du nom des nœuds
            const labels = svg.append('g')
                .selectAll('text')
                .data(data.nodes)
                .enter().append('text')
                .text(d => d.id)
                .attr('font-size', '14px')
                .attr('font-weight', 'bold')
                .attr('fill', '#222')
                .attr('dx', 20)
                .attr('dy', 5);
            node.append('title').text(d => d.id);
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }
    </script>
</body>
</html>
